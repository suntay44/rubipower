<!-- Main Content -->
    <!-- Top Navigation -->
    <header class="bg-white shadow-sm border-b border-gray-200">
      <div class="flex items-center justify-between px-6 py-4">
        <div class="flex items-center space-x-4">
          <button id="mobile-sidebar-toggle" class="text-gray-500 hover:text-gray-700 lg:hidden">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
          </button>
          <div class="flex items-center space-x-3">
            <a href="<%= purchase_request_path %>" class="text-gray-500 hover:text-gray-700">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
            </a>
            <h1 class="text-2xl font-bold text-gray-900">Purchase Request #<%= @purchase_request.id %></h1>
          </div>
        </div>
        
        <div class="flex items-center space-x-4">
          <a href="<%= edit_purchase_request_path(@purchase_request) %>" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm font-medium">
            Edit
          </a>
          <span class="inline-flex px-3 py-1 text-sm font-semibold rounded-full
            <%= case @purchase_request.priority_level
                when 'urgent' then 'bg-red-100 text-red-800'
                when 'high' then 'bg-orange-100 text-orange-800'
                when 'medium' then 'bg-yellow-100 text-yellow-800'
                when 'low' then 'bg-green-100 text-green-800'
                else 'bg-gray-100 text-gray-800'
                end %>">
            <%= @purchase_request.priority_level&.humanize || 'Not Set' %>
          </span>
        </div>
      </div>
    </header>

    <!-- Content -->
    <div class="p-6">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Basic Information -->
          <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <svg class="w-5 h-5 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              Basic Information
              <span class="ml-2 text-xs text-red-500 font-normal"> 
                <% if @purchase_request.purchase_order.present? %>
                  <a href="<%= purchase_request_purchase_order_path(@purchase_request) %>" class="text-xs text-blue-600 bg-blue-100 px-2 py-1 rounded-md font-medium hover:text-blue-800 flex items-center">
                    View Purchase Order
                  </a>
                  <span class="ml-2 inline-flex px-2 py-1 text-xs font-semibold rounded-full
                    <%= case @purchase_request.purchase_order.status
                        when 'draft' then 'bg-gray-100 text-gray-800'
                        when 'approved' then 'bg-green-100 text-green-800'
                        when 'sent' then 'bg-blue-100 text-blue-800'
                        when 'goods_received' then 'bg-yellow-100 text-yellow-800'
                        when 'invoice_matched' then 'bg-yellow-100 text-yellow-800'
                        when 'payment_processed' then 'bg-purple-100 text-purple-800'
                        when 'cancelled' then 'bg-red-100 text-red-800'
                        else 'bg-gray-100 text-gray-800'
                        end %>">
                    P.O.: <%= @purchase_request.purchase_order.status&.humanize || 'Unknown' %>
                  </span>
                <% elsif @purchase_request.all_approvals_complete? %>
                  <span class="text-xs text-green-600 font-medium">✓ Ready for P.O.</span>
                <% else %>
                  <% if @purchase_request.manager_approved? && !@purchase_request.finance_approved? %>
                    <span class="text-xs text-red-600 font-medium">⚠️ Need Finance Approval</span>
                  <% elsif !@purchase_request.manager_approved? && @purchase_request.finance_approved? %>
                    <span class="text-xs text-red-600 font-medium">⚠️ Need Manager Approval</span>
                  <% else %>
                    <span class="text-xs text-red-600 font-medium italic">⚠️ Need Manager & Finance Approvals</span>
                  <% end %>
                <% end %>
              </span>
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Request Date</label>
                <p class="text-sm text-gray-900"><%= @purchase_request.request_date.strftime("%B %d, %Y") %></p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Requester</label>
                <p class="text-sm text-gray-900"><%= @purchase_request.requester_user&.email || 'Unknown' %></p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Priority Level</label>
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                  <%= case @purchase_request.priority_level
                      when 'urgent' then 'bg-red-100 text-red-800'
                      when 'high' then 'bg-orange-100 text-orange-800'
                      when 'medium' then 'bg-yellow-100 text-yellow-800'
                      when 'low' then 'bg-green-100 text-green-800'
                      else 'bg-gray-100 text-gray-800'
                      end %>">
                  <%= @purchase_request.priority_level&.humanize || 'Not Set' %>
                </span>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Created At</label>
                <p class="text-sm text-gray-900"><%= @purchase_request.created_at.strftime("%B %d, %Y at %I:%M %p") %></p>
              </div>
            </div>
          </div>

          <!-- Items Details -->
          <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <svg class="w-5 h-5 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
              </svg>
              Items (<%= @purchase_request.items.count %>)
            </h3>
            
            <% if @purchase_request.items.any? %>
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quoted Price</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
                    <% @purchase_request.items.each do |item| %>
                      <tr>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900"><%= item.name %></td>
                        <td class="px-6 py-4 text-sm text-gray-900"><%= item.description %></td>
                        <td class="px-6 py-4 text-sm text-gray-900"><%= item.quantity %></td>
                        <td class="px-6 py-4 text-sm text-gray-900">₱<%= number_with_precision(item.quoted_price, precision: 2) %></td>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">₱<%= number_with_precision(item.quantity * item.quoted_price, precision: 2) %></td>
                      </tr>
                    <% end %>
                  </tbody>
                  <tfoot class="bg-gray-50">
                    <tr>
                      <td colspan="4" class="px-6 py-4 text-sm font-medium text-gray-900 text-right">Total:</td>
                      <td class="px-6 py-4 text-sm font-bold text-gray-900">₱<%= number_with_precision(@purchase_request.items.sum { |item| item.quantity * item.quoted_price }, precision: 2) %></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            <% else %>
              <p class="text-sm text-gray-500">No items found for this purchase request.</p>
            <% end %>
          </div>

          <!-- Additional Information -->
          <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <svg class="w-5 h-5 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              Additional Information
            </h3>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Reason for Purchase</label>
                <p class="text-sm text-gray-900"><%= @purchase_request.reason_for_purchase || 'Not provided' %></p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Client Name</label>
                <p class="text-sm text-gray-900"><%= @purchase_request.client_name || 'Not provided' %></p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Additional Notes</label>
                <p class="text-sm text-gray-900"><%= @purchase_request.additional_notes || 'Not provided' %></p>
              </div>
            </div>
          </div>

          <!-- Vendor Information -->
          <% vendors = @purchase_request.items.map(&:vendor).compact.uniq %>
          <% if vendors.any? %>
            <div class="bg-white rounded-lg shadow-sm p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <svg class="w-5 h-5 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
                Vendor Information
              </h3>
              
              <div class="space-y-6">
                <% vendors.each do |vendor| %>
                  <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="text-md font-semibold text-gray-900 mb-4"><%= vendor.name %></h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-500 mb-1">Address</label>
                        <p class="text-sm text-gray-900"><%= vendor.address.presence || "N/A" %></p>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-500 mb-1">TIN (2303)</label>
                        <p class="text-sm text-gray-900"><%= vendor.tin.presence || "N/A" %></p>
                      </div>
                      <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-500 mb-1">Bank Details</label>
                        <p class="text-sm text-gray-900"><%= vendor.bank_details.presence || "N/A" %></p>
                      </div>
                    </div>
                    
                    <!-- Vendor Attachments -->
                    <% if vendor.tax_certificate.attached? || vendor.sales_invoice.attached? || vendor.vendor_quotation.attached? %>
                      <div class="mt-4 pt-4 border-t border-gray-200">
                        <h5 class="text-sm font-medium text-gray-700 mb-3">Attachments</h5>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <% if vendor.tax_certificate.attached? %>
                            <div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50">
                              <div class="flex items-center space-x-2">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <div class="flex-1 min-w-0">
                                  <p class="text-xs font-medium text-gray-900 truncate">2303 Tax Certificate</p>
                                  <p class="text-xs text-gray-500"><%= number_to_human_size(vendor.tax_certificate.byte_size) %></p>
                                </div>
                              </div>
                              <div class="mt-2">
                                <%= link_to "Download", rails_blob_path(vendor.tax_certificate, disposition: "attachment"), class: "text-xs text-red-600 hover:text-red-900" %>
                              </div>
                            </div>
                          <% end %>

                          <% if vendor.sales_invoice.attached? %>
                            <div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50">
                              <div class="flex items-center space-x-2">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <div class="flex-1 min-w-0">
                                  <p class="text-xs font-medium text-gray-900 truncate">Sample Sales Invoice</p>
                                  <p class="text-xs text-gray-500"><%= number_to_human_size(vendor.sales_invoice.byte_size) %></p>
                                </div>
                              </div>
                              <div class="mt-2">
                                <%= link_to "Download", rails_blob_path(vendor.sales_invoice, disposition: "attachment"), class: "text-xs text-red-600 hover:text-red-900" %>
                              </div>
                            </div>
                          <% end %>

                          <% if vendor.vendor_quotation.attached? %>
                            <div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50">
                              <div class="flex items-center space-x-2">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <div class="flex-1 min-w-0">
                                  <p class="text-xs font-medium text-gray-900 truncate">Vendor Quotation</p>
                                  <p class="text-xs text-gray-500"><%= number_to_human_size(vendor.vendor_quotation.byte_size) %></p>
                                </div>
                              </div>
                              <div class="mt-2">
                                <%= link_to "Download", rails_blob_path(vendor.vendor_quotation, disposition: "attachment"), class: "text-xs text-red-600 hover:text-red-900" %>
                              </div>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- Material Requisition Slip Proposals -->
          <% if @purchase_request.material_requisition_slip.present? && @purchase_request.material_requisition_slip.proposals.attached? %>
            <div class="bg-white rounded-lg shadow-sm p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <svg class="w-5 h-5 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                MRS-<%= @purchase_request.material_requisition_slip.id.to_s.rjust(4, '0') %> Proposals
              </h3>
              
              <div class="mb-4">
                <p class="text-sm text-gray-600 mb-3">
                  Proposals from Material Requisition Slip #<%= @purchase_request.material_requisition_slip.id.to_s.rjust(4, '0') %>
                </p>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <% @purchase_request.material_requisition_slip.proposals.each do |proposal| %>
                  <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                    <div class="flex items-center space-x-3">
                      <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                      </svg>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate"><%= proposal.filename %></p>
                        <p class="text-xs text-gray-500"><%= number_to_human_size(proposal.byte_size) %></p>
                      </div>
                    </div>
                    <div class="mt-3">
                      <%= link_to "Download", rails_blob_path(proposal, disposition: "attachment"), class: "text-sm text-red-600 hover:text-red-900" %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
          <!-- Status Card -->
          <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Status</h3>
            
            <div class="space-y-4">
              <div class="flex items-center justify-between">
                <span class="text-sm font-medium text-gray-700">Manager Approval</span>
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                  <%= @purchase_request.manager_approved? ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800' %>">
                  <%= @purchase_request.manager_approved? ? 'Approved' : 'Pending' %>
                </span>
              </div>
              
              <div class="flex items-center justify-between">
                <span class="text-sm font-medium text-gray-700">Finance Approval</span>
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                  <%= @purchase_request.finance_approved? ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800' %>">
                  <%= @purchase_request.finance_approved? ? 'Approved' : 'Pending' %>
                </span>
              </div>
            </div>
          </div>

          <!-- Summary Card -->
          <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Summary</h3>
            
            <div class="space-y-3">
              <div class="flex justify-between">
                <span class="text-sm text-gray-600">Total Items:</span>
                <span class="text-sm font-medium text-gray-900"><%= @purchase_request.items.count %></span>
              </div>
              
              <div class="flex justify-between">
                <span class="text-sm text-gray-600">Total Cost:</span>
                <span class="text-sm font-medium text-gray-900">₱<%= number_with_precision(@purchase_request.items.sum { |item| item.quantity * item.quoted_price }, precision: 2) %></span>
              </div>
              
              <div class="flex justify-between">
                <span class="text-sm text-gray-600">Attachments:</span>
                <span class="text-sm font-medium text-gray-900">
                  <% 
                    attachment_count = 0
                    vendors = @purchase_request.items.map(&:vendor).compact.uniq
                    vendors.each do |vendor|
                      attachment_count += 1 if vendor.tax_certificate.attached?
                      attachment_count += 1 if vendor.sales_invoice.attached?
                      attachment_count += 1 if vendor.vendor_quotation.attached?
                    end
                    # Add MRS proposals count
                    if @purchase_request.material_requisition_slip.present?
                      attachment_count += @purchase_request.material_requisition_slip.proposals.count
                    end
                  %>
                  <%= attachment_count %>
                </span>
              </div>
            </div>
          </div>

          <!-- Actions Card -->
          <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Actions</h3>
            
            <div class="space-y-3">
              <!-- Approval buttons side by side -->
              <div class="flex gap-4 justify-center">
                <!-- Manager Approval Button -->
                <% if current_user.manager? %>
                  <% if @purchase_request.manager_approved? %>
                    <span class="text-xs text-gray-600 font-medium">Manager: ✓ Approved</span>
                  <% else %>
                    <%= button_to "Approve Manager", approve_manager_purchase_request_path(@purchase_request), method: :patch, class: "bg-green-600 text-white px-4 py-2 rounded-md text-center text-sm font-medium hover:bg-green-700 transition-colors duration-200 shadow-sm hover:shadow-md border border-green-700", data: { confirm: "Are you sure you want to approve this purchase request as Manager?" } %>
                  <% end %>
                <% end %>
                
                <!-- Finance Approval Button (Admin with Finance department only) -->
                <% if current_user.admin? && current_user.department_finance? %>
                  <% if @purchase_request.finance_approved? %>
                    <span class="text-xs text-gray-600 font-medium">Finance: ✓ Approved</span>
                  <% else %>
                    <%= button_to "Approve Finance", approve_finance_purchase_request_path(@purchase_request), method: :patch, class: "bg-blue-600 text-white px-4 py-2 rounded-md text-center text-sm font-medium hover:bg-blue-700 transition-colors duration-200 shadow-sm hover:shadow-md border border-blue-700", data: { confirm: "Are you sure you want to approve this purchase request as Finance?" } %>
                  <% end %>
                <% end %>
              </div>
              
              <!-- Purchase Order button -->
              <div class="flex gap-2 justify-center items-center">
                <% if @purchase_request.purchase_order.present? %>
                  <!-- View Purchase Order (PO already exists) -->
                  <a href="<%= purchase_request_purchase_order_path(@purchase_request) %>" class="bg-green-600 text-white px-4 py-2 rounded-md text-center text-sm font-medium hover:bg-green-700 transition-colors duration-200 shadow-sm hover:shadow-md border border-green-700">
                    View Purchase Order (P.O.)
                  </a>
                  <span class="ml-2 inline-flex px-2 py-1 text-xs font-semibold rounded-full
                    <%= case @purchase_request.purchase_order.status
                        when 'draft' then 'bg-gray-100 text-gray-800'
                        when 'approved' then 'bg-green-100 text-green-800'
                        when 'sent' then 'bg-blue-100 text-blue-800'
                        when 'goods_received' then 'bg-yellow-100 text-yellow-800'
                        when 'invoice_matched' then 'bg-yellow-100 text-yellow-800'
                        when 'payment_processed' then 'bg-purple-100 text-purple-800'
                        when 'cancelled' then 'bg-red-100 text-red-800'
                        else 'bg-gray-100 text-gray-800'
                        end %>">
                    P.O.: <%= @purchase_request.purchase_order.status&.humanize || 'Unknown' %>
                  </span>
                <% elsif @purchase_request.all_approvals_complete? %>
                  <!-- Create Purchase Order (approvals ready, no PO exists) -->
                  <%= button_to "Create Purchase Order", create_purchase_order_path(@purchase_request), method: :post, class: "bg-blue-600 text-white px-4 py-2 rounded-md text-center text-sm font-medium hover:bg-blue-700 transition-colors duration-200 shadow-sm hover:shadow-md border border-blue-700", data: { confirm: "Are you sure you want to create a Purchase Order for this request?" } %>
                  <span class="ml-2 text-xs text-green-600 font-medium">✓ Ready</span>
                <% else %>
                  <!-- Disabled button (approvals missing) -->
                  <button disabled class="bg-blue-500 text-white px-4 py-2 rounded-md text-center text-sm font-medium cursor-not-allowed border border-blue-500 opacity-50">
                    Create Purchase Order (P.O.)
                  </button>
                  <% if @purchase_request.manager_approved? && !@purchase_request.finance_approved? %>
                    <span class="text-xs text-yellow-600 font-medium">⚠️ Need Finance Approval</span>
                  <% elsif !@purchase_request.manager_approved? && @purchase_request.finance_approved? %>
                    <span class="text-xs text-yellow-600 font-medium">⚠️ Need Manager Approval</span>
                  <% else %>
                    <span class="text-xs text-gray-600 font-medium">⚠️ Need Both Approvals</span>
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function confirmAndSubmit(type, action) {
        const messages = {
          'budget': {
            'approve': 'Are you sure you want to approve the budget for this purchase request?',
            'disapprove': 'Are you sure you want to disapprove the budget for this purchase request?'
          },
          'procurement': {
            'approve': 'Are you sure you want to approve the procurement for this purchase request?',
            'disapprove': 'Are you sure you want to disapprove the procurement for this purchase request?'
          }
        };

        const message = messages[type][action];
        
        if (confirm(message)) {
          // Create a form and submit it
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = `/purchase-request/<%= @purchase_request.id %>/approve-${type}`;
          
          // Add CSRF token
          const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
          const csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = 'authenticity_token';
          csrfInput.value = csrfToken;
          form.appendChild(csrfInput);
          
          // Add method override for PATCH
          const methodInput = document.createElement('input');
          methodInput.type = 'hidden';
          methodInput.name = '_method';
          methodInput.value = 'PATCH';
          form.appendChild(methodInput);
          
          document.body.appendChild(form);
          form.submit();
        }
      }

      function confirmCreatePO() {
        if (confirm('Are you sure you want to create a Purchase Order for this request? This action cannot be undone.')) {
          // Create a form and submit it
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = `/purchase-request/<%= @purchase_request.id %>/create-purchase-order`;
          
          // Add CSRF token
          const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
          const csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = 'authenticity_token';
          csrfInput.value = csrfToken;
          form.appendChild(csrfInput);
          
          document.body.appendChild(form);
          form.submit();
        }
      }
    </script>