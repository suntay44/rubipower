<div class="min-h-screen bg-gray-50">
  <!-- Flash Messages -->
  <% if notice %>
    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4 mx-4 mt-4">
      <%= notice %>
    </div>
  <% end %>

  <!-- Header -->
  <div class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="py-6">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">New Sale</h1>
            <p class="mt-1 text-sm text-gray-500">Create a new sale transaction</p>
          </div>
          <div class="flex space-x-3">
            <%= link_to inventory_sales_sales_path, class: "bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors" do %>
              <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
              </svg>
              Back to Sales
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Form Content -->
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <%= form_with model: @sale, url: create_inventory_sales_sale_path, local: true, class: "space-y-8" do |form| %>
        <% if @sale.errors.any? %>
          <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <div class="flex">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
              </div>
              <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">
                  There were <%= pluralize(@sale.errors.count, "error") %> with your submission:
                </h3>
                <div class="mt-2 text-sm text-red-700">
                  <ul class="list-disc list-inside space-y-1">
                    <% @sale.errors.full_messages.each do |message| %>
                      <li><%= message %></li>
                    <% end %>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        <% end %>

        <!-- Basic Information -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            Sale Information
          </h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="md:col-span-2">
              <%= form.label :client_name, "Client's Name *", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.text_field :client_name, 
                  class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent", 
                  placeholder: "Enter client name",
                  required: true %>
            </div>

            <div class="md:col-span-2">
              <%= form.label :description, "Description *", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.text_area :description, rows: 4,
                  class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent", 
                  placeholder: "Enter description of the sale...",
                  required: true %>
            </div>

            <div>
              <%= form.label :sale_date, "Sale Date", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.date_field :sale_date, 
                  value: Date.current,
                  class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" %>
            </div>

            <div>
              <%= form.label :payment_status, "Payment Status", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.select :payment_status, 
                  options_for_select([['Pending', 'pending'], ['Paid', 'paid'], ['Failed', 'failed'], ['Refunded', 'refunded']], @sale.payment_status || 'pending'),
                  {},
                  { class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" } %>
            </div>

            <div>
              <%= form.label :payment_method, "Payment Method", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.select :payment_method, 
                  options_for_select([['Cash', 'cash'], ['Credit Card', 'credit_card'], ['Bank Transfer', 'bank_transfer'], ['Digital Wallet', 'digital_wallet']], @sale.payment_method),
                  { prompt: "Select payment method" },
                  { class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" } %>
            </div>
          </div>
        </div>

        <!-- Items List -->
        <div class="mb-8">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
              <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
              </svg>
              Items List *
            </h3>
            <button type="button" onclick="addSaleItem()" class="px-3 py-1 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 transition-colors">
              + Add Item
            </button>
          </div>
          
          <div id="sale-items-container" class="space-y-3">
            <!-- Items will be added here dynamically -->
          </div>

          <div id="sale-items-total" class="mt-4 p-3 bg-gray-50 rounded-md border border-gray-200">
            <div class="flex justify-between items-center">
              <span class="text-sm font-semibold text-gray-700">Total Amount:</span>
              <span class="text-lg font-bold text-gray-900">PHP <span id="total-amount-display">0.00</span></span>
            </div>
          </div>
          <%= form.hidden_field :total_amount, id: "total_amount_hidden" %>
        </div>

        <!-- Form Actions -->
        <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
          <%= link_to "Cancel", inventory_sales_sales_path, class: "px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" %>
          <%= form.submit "Create Sale", class: "px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  // Product data for JavaScript
  const products = <%= raw @products.map { |p| { id: p.id, name: p.name, price: p.price.to_f, sku: p.sku, stock_quantity: p.stock_quantity } }.to_json %>;
  
  let saleItemCounter = 0;

  function addSaleItem(productId = '', quantity = '', unitPrice = '') {
    saleItemCounter++;
    const container = document.getElementById('sale-items-container');
    const itemRow = document.createElement('div');
    itemRow.className = 'sale-item-row bg-gray-50 border border-gray-200 rounded-lg p-4';
    itemRow.id = `sale-item-${saleItemCounter}`;
    
    const productSelect = productId ? 
      `<option value="${productId}" selected>${products.find(p => p.id == productId)?.name || ''}</option>` :
      '<option value="">Select Product</option>';
    
    itemRow.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
        <div class="md:col-span-5">
          <label class="block text-sm font-medium text-gray-700 mb-2">Product *</label>
          <select class="sale-item-product w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" required onchange="updateProductPrice(${saleItemCounter})">
            <option value="">Select Product</option>
            ${products.map(p => `<option value="${p.id}" data-price="${p.price}" data-stock="${p.stock_quantity}" ${p.id == productId ? 'selected' : ''}>${p.name} (PHP ${p.price.toFixed(2)}) - Stock: ${p.stock_quantity}</option>`).join('')}
          </select>
          <div class="sale-item-stock-info mt-1 text-xs text-gray-500" id="stock-info-${saleItemCounter}"></div>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-2">Quantity *</label>
          <input type="number" step="1" min="0" class="sale-item-quantity w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="0" value="${quantity || '0'}" required onchange="calculateItemTotal(${saleItemCounter}); checkStockAvailability(${saleItemCounter})" oninput="calculateItemTotal(${saleItemCounter}); checkStockAvailability(${saleItemCounter})">
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-2">Unit Price (PHP) *</label>
          <input type="number" step="0.01" min="0" class="sale-item-unit-price w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="0.00" value="${unitPrice}" required onchange="calculateItemTotal(${saleItemCounter})" oninput="calculateItemTotal(${saleItemCounter})">
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-2">Total (PHP)</label>
          <input type="text" class="sale-item-total w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600" readonly value="0.00">
        </div>
        <div class="md:col-span-1">
          <button type="button" onclick="removeSaleItem(${saleItemCounter})" class="w-full px-3 py-2 bg-red-600 text-white text-sm rounded-md hover:bg-red-700 transition-colors">
            Remove
          </button>
        </div>
      </div>
      <input type="hidden" name="sale[sale_items_attributes][${saleItemCounter}][product_id]" class="sale-item-product-id">
      <input type="hidden" name="sale[sale_items_attributes][${saleItemCounter}][quantity]" class="sale-item-quantity-hidden">
      <input type="hidden" name="sale[sale_items_attributes][${saleItemCounter}][unit_price]" class="sale-item-unit-price-hidden">
      <input type="hidden" name="sale[sale_items_attributes][${saleItemCounter}][total_price]" class="sale-item-total-price">
    `;
    
    container.appendChild(itemRow);
    
    if (productId) {
      const select = itemRow.querySelector('.sale-item-product');
      select.value = productId;
      updateProductPrice(saleItemCounter);
    }
    
    // Always calculate total to initialize hidden fields
    calculateItemTotal(saleItemCounter);
    
    if (quantity && quantity > 0) {
      // If quantity is provided, ensure it's calculated
      const quantityInput = itemRow.querySelector('.sale-item-quantity');
      if (quantityInput) {
        quantityInput.value = quantity;
        calculateItemTotal(saleItemCounter);
      }
    }
  }

  function removeSaleItem(itemId) {
    const itemRow = document.getElementById(`sale-item-${itemId}`);
    if (itemRow) {
      itemRow.remove();
      updateTotalAmount();
    }
  }

  function updateProductPrice(itemId) {
    const itemRow = document.getElementById(`sale-item-${itemId}`);
    const select = itemRow.querySelector('.sale-item-product');
    const unitPriceInput = itemRow.querySelector('.sale-item-unit-price');
    const unitPriceHidden = itemRow.querySelector('.sale-item-unit-price-hidden');
    const productIdInput = itemRow.querySelector('.sale-item-product-id');
    const stockInfo = itemRow.querySelector('.sale-item-stock-info');
    
    const selectedProduct = products.find(p => p.id == select.value);
    if (selectedProduct) {
      unitPriceInput.value = selectedProduct.price.toFixed(2);
      if (unitPriceHidden) unitPriceHidden.value = selectedProduct.price.toFixed(2);
      productIdInput.value = selectedProduct.id;
      
      // Update stock info
      if (stockInfo) {
        if (selectedProduct.stock_quantity > 0) {
          stockInfo.textContent = `Available stock: ${selectedProduct.stock_quantity}`;
          stockInfo.className = 'sale-item-stock-info mt-1 text-xs text-green-600';
        } else {
          stockInfo.textContent = 'Out of stock';
          stockInfo.className = 'sale-item-stock-info mt-1 text-xs text-red-600 font-semibold';
        }
      }
    } else {
      unitPriceInput.value = '';
      if (unitPriceHidden) unitPriceHidden.value = '';
      productIdInput.value = '';
      if (stockInfo) {
        stockInfo.textContent = '';
      }
    }
    
    calculateItemTotal(itemId);
    checkStockAvailability(itemId);
  }

  function checkStockAvailability(itemId) {
    const itemRow = document.getElementById(`sale-item-${itemId}`);
    if (!itemRow) return;
    
    const select = itemRow.querySelector('.sale-item-product');
    const quantityInput = itemRow.querySelector('.sale-item-quantity');
    const stockInfo = itemRow.querySelector('.sale-item-stock-info');
    
    if (!select || !quantityInput || !stockInfo) return;
    
    const selectedProduct = products.find(p => p.id == select.value);
    if (selectedProduct) {
      const requestedQuantity = parseInt(quantityInput.value) || 0;
      const availableStock = selectedProduct.stock_quantity;
      
      if (requestedQuantity > availableStock) {
        stockInfo.textContent = `Insufficient stock! Available: ${availableStock}, Requested: ${requestedQuantity}`;
        stockInfo.className = 'sale-item-stock-info mt-1 text-xs text-red-600 font-semibold';
        quantityInput.classList.add('border-red-500');
      } else if (requestedQuantity > 0) {
        stockInfo.textContent = `Available stock: ${availableStock}`;
        stockInfo.className = 'sale-item-stock-info mt-1 text-xs text-green-600';
        quantityInput.classList.remove('border-red-500');
      }
    }
  }

  function calculateItemTotal(itemId) {
    const itemRow = document.getElementById(`sale-item-${itemId}`);
    const quantityInput = itemRow.querySelector('.sale-item-quantity');
    const unitPriceInput = itemRow.querySelector('.sale-item-unit-price');
    const totalInput = itemRow.querySelector('.sale-item-total');
    const totalPriceInput = itemRow.querySelector('.sale-item-total-price');
    const quantityHidden = itemRow.querySelector('.sale-item-quantity-hidden');
    const unitPriceHidden = itemRow.querySelector('.sale-item-unit-price-hidden');
    
    const quantity = parseFloat(quantityInput.value) || 0;
    const unitPrice = parseFloat(unitPriceInput.value) || 0;
    const total = quantity * unitPrice;
    
    totalInput.value = total.toFixed(2);
    totalPriceInput.value = total.toFixed(2);
    
    // Update hidden fields for form submission
    if (quantityHidden) quantityHidden.value = quantity;
    if (unitPriceHidden) unitPriceHidden.value = unitPrice.toFixed(2);
    
    updateTotalAmount();
  }

  function updateTotalAmount() {
    let totalAmount = 0;
    
    document.querySelectorAll('.sale-item-row').forEach(row => {
      const totalInput = row.querySelector('.sale-item-total');
      if (totalInput) {
        totalAmount += parseFloat(totalInput.value) || 0;
      }
    });
    
    document.getElementById('total-amount-display').textContent = totalAmount.toFixed(2);
    document.getElementById('total_amount_hidden').value = totalAmount.toFixed(2);
  }

  // Sync all hidden fields before form submission
  function syncAllHiddenFields() {
    document.querySelectorAll('.sale-item-row').forEach(row => {
      const quantityInput = row.querySelector('.sale-item-quantity');
      const unitPriceInput = row.querySelector('.sale-item-unit-price');
      const quantityHidden = row.querySelector('.sale-item-quantity-hidden');
      const unitPriceHidden = row.querySelector('.sale-item-unit-price-hidden');
      
      if (quantityInput && quantityHidden) {
        quantityHidden.value = parseFloat(quantityInput.value) || 0;
      }
      if (unitPriceInput && unitPriceHidden) {
        unitPriceHidden.value = parseFloat(unitPriceInput.value) || 0;
      }
      calculateItemTotal(parseInt(row.id.replace('sale-item-', '')));
    });
  }

  // Initialize with one empty item on page load
  document.addEventListener('DOMContentLoaded', function() {
    addSaleItem();
    
    // Update total amount before form submission
    const form = document.querySelector('form');
    if (form) {
      form.addEventListener('submit', function(e) {
        // Sync all hidden fields before submission
        syncAllHiddenFields();
        updateTotalAmount();
        
        // Validate that at least one item exists
        const items = document.querySelectorAll('.sale-item-row');
        if (items.length === 0) {
          e.preventDefault();
          alert('Please add at least one item.');
          return false;
        }
        
        // Validate all items have product and quantity > 0
        let hasInvalidItem = false;
        items.forEach(item => {
          const product = item.querySelector('.sale-item-product').value;
          const quantityInput = item.querySelector('.sale-item-quantity');
          const quantity = quantityInput ? parseFloat(quantityInput.value) : 0;
          if (!product || !quantity || quantity <= 0) {
            hasInvalidItem = true;
          }
        });
        
        if (hasInvalidItem) {
          e.preventDefault();
          alert('Please fill in all required fields for each item. Quantity must be greater than 0.');
          return false;
        }
      });
    }
  });
</script>

