<!-- Main Content -->
<!-- Top Navigation -->
<header class="bg-white shadow-sm border-b border-gray-200">
  <div class="flex items-center justify-between px-6 py-4">
    <div class="flex items-center space-x-4">
      <button id="mobile-sidebar-toggle" class="text-gray-500 hover:text-gray-700 lg:hidden">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
      <div class="flex items-center space-x-3">
        <a href="<%= purchase_request_detail_path(@purchase_request) %>" class="text-gray-500 hover:text-gray-700">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </a>
        <h1 class="text-2xl font-bold text-gray-900">Purchase Order #<%= @purchase_order.po_number %></h1>
      </div>
    </div>
    
    <div class="flex items-center space-x-4">
      <span class="inline-flex px-3 py-1 text-sm font-semibold rounded-full
        <%= case @purchase_order.status
            when 'draft' then 'bg-gray-100 text-gray-800'
            when 'approved' then 'bg-green-100 text-green-800'
            when 'sent' then 'bg-blue-100 text-blue-800'
            when 'goods_received' then 'bg-yellow-100 text-yellow-800'
            when 'invoice_matched' then 'bg-yellow-100 text-yellow-800'
            when 'payment_processed' then 'bg-purple-100 text-purple-800'
            when 'cancelled' then 'bg-red-100 text-red-800'
            else 'bg-gray-100 text-gray-800'
            end %>">
        <%= @purchase_order.status&.humanize || 'Unknown' %>
      </span>
    </div>
  </div>
</header>

<!-- Content -->
<div class="p-6">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Status Log Table -->
      <div class="bg-white rounded-lg shadow-sm p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
          <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          Status History
        </h3>
        
        <% if @status_logs.any? %>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Updated By</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <% @status_logs.each do |log| %>
                  <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                        <%= case log.status
                            when 'draft' then 'bg-gray-100 text-gray-800'
                            when 'approved' then 'bg-green-100 text-green-800'
                            when 'sent' then 'bg-blue-100 text-blue-800'
                            when 'goods_received' then 'bg-yellow-100 text-yellow-800'
                            when 'invoice_matched' then 'bg-yellow-100 text-yellow-800'
                            when 'payment_processed' then 'bg-purple-100 text-purple-800'
                            when 'cancelled' then 'bg-red-100 text-red-800'
                            else 'bg-gray-100 text-gray-800'
                            end %>">
                        <%= log.status&.humanize || 'Unknown' %>
                      </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                      <%= log.updated_by&.email || 'System' %>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                      <%= log.updated_at.strftime("%B %d, %Y at %I:%M %p") %>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">
                      <%= log.notes || '-' %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <p class="text-sm text-gray-500">No status changes recorded yet.</p>
        <% end %>
      </div>

      <!-- Purchase Order Details -->
      <div class="bg-white rounded-lg shadow-sm p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
          <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          Purchase Order Information
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">PO Number</label>
            <p class="text-sm text-gray-900 font-mono"><%= @purchase_order.po_number %></p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
              <%= case @purchase_order.status
                  when 'draft' then 'bg-gray-100 text-gray-800'
                  when 'approved' then 'bg-green-100 text-green-800'
                  when 'sent' then 'bg-blue-100 text-blue-800'
                  when 'goods_received' then 'bg-yellow-100 text-yellow-800'
                  when 'invoice_matched' then 'bg-yellow-100 text-yellow-800'
                  when 'payment_processed' then 'bg-purple-100 text-purple-800'
                  when 'cancelled' then 'bg-red-100 text-red-800'
                  else 'bg-gray-100 text-gray-800'
                  end %>">
              <%= @purchase_order.status&.humanize || 'Unknown' %>
            </span>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Total Amount</label>
            <p class="text-sm text-gray-900 font-semibold">$<%= number_with_precision(@purchase_order.total_amount, precision: 2) %></p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Created At</label>
            <p class="text-sm text-gray-900"><%= @purchase_order.created_at.strftime("%B %d, %Y at %I:%M %p") %></p>
          </div>
        </div>
      </div>

      <!-- Delivery Information -->
      <% if @purchase_order.delivery_note.present? || @purchase_order.inspection_report.attached? %>
      <div class="bg-white rounded-lg shadow-sm p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
          <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
          </svg>
          Delivery Information
        </h3>
        <div class="space-y-4">
          <% if @purchase_order.delivery_note.present? %>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Note</label>
            <div class="bg-gray-50 p-3 rounded-md">
              <p class="text-sm text-gray-900 whitespace-pre-line"><%= @purchase_order.delivery_note %></p>
            </div>
          </div>
          <% end %>
          
          <% if @purchase_order.inspection_report.attached? %>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Inspection Report</label>
            <div class="flex items-center space-x-3">
              <a href="<%= rails_blob_path(@purchase_order.inspection_report, disposition: "attachment") %>" 
                 class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Download Inspection Report
              </a>
              <span class="text-sm text-gray-500">
                (<%= number_to_human_size(@purchase_order.inspection_report.byte_size) %>)
              </span>
            </div>
          </div>
          <% end %>
        </div>
      </div>
      <% end %>

      <!-- Vendor Information -->
      <div class="bg-white rounded-lg shadow-sm p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
          <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
          </svg>
          Vendor Information
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Vendor Name</label>
            <p class="text-sm text-gray-900"><%= @purchase_request.vendor_name || 'Not provided' %></p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Sales Order Number</label>
            <p class="text-sm text-gray-900"><%= @purchase_request.sales_order_number || 'Not provided' %></p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Vendor Address</label>
            <p class="text-sm text-gray-900"><%= @purchase_request.vendor_address || 'Not provided' %></p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Bank Details</label>
            <p class="text-sm text-gray-900"><%= @purchase_request.bank_details || 'Not provided' %></p>
          </div>
        </div>
      </div>

      <!-- Items Details -->
      <div class="bg-white rounded-lg shadow-sm p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
          <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
          </svg>
          Items (<%= @purchase_request.items.count %>)
        </h3>
        
        <% if @purchase_request.items.any? %>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Price</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <% @purchase_request.items.each do |item| %>
                  <tr>
                    <td class="px-6 py-4 text-sm text-gray-900"><%= item.description %></td>
                    <td class="px-6 py-4 text-sm text-gray-900"><%= item.quantity %></td>
                    <td class="px-6 py-4 text-sm text-gray-900">$<%= number_with_precision(item.cost, precision: 2) %></td>
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">$<%= number_with_precision(item.quantity * item.cost, precision: 2) %></td>
                  </tr>
                <% end %>
              </tbody>
              <tfoot class="bg-gray-50">
                <tr>
                  <td colspan="3" class="px-6 py-4 text-sm font-medium text-gray-900 text-right">Total Amount:</td>
                  <td class="px-6 py-4 text-sm font-bold text-gray-900">$<%= number_with_precision(@purchase_order.total_amount, precision: 2) %></td>
                </tr>
              </tfoot>
            </table>
          </div>
        <% else %>
          <p class="text-sm text-gray-500">No items found for this purchase order.</p>
        <% end %>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
      <!-- Actions Card -->
      <div class="bg-white rounded-lg shadow-sm p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Actions</h3>
        
        <div class="space-y-3">
          
          <!-- Simplified PO Workflow -->
          
          <!-- Row 1: Approve PO -->
          <div class="flex gap-2 justify-center">
            <% if @purchase_order.status == 'draft' %>
              <button onclick="confirmAndUpdateStatus('approved')" class="bg-green-600 text-white px-4 py-2 rounded-md text-center text-sm font-medium hover:bg-green-700 transition-colors duration-200 shadow-sm hover:shadow-md border border-green-700">
                Approve PO
              </button>
            <% end %>
          </div>
          
          <!-- Row 2: Send to Vendor -->
          <div class="flex gap-2 justify-center">
            <% if @purchase_order.status == 'approved' %>
              <button onclick="confirmAndUpdateStatus('sent')" class="bg-green-600 text-white px-4 py-2 rounded-md text-center text-sm font-medium hover:bg-green-700 transition-colors duration-200 shadow-sm hover:shadow-md border border-green-700">
                Send to Vendor
              </button>
            <% end %>
          </div>
          
          <!-- Row 3: Goods Received (with modal) -->
          <div class="flex gap-2 justify-center">
            <% if @purchase_order.status == 'sent' %>
              <button onclick="openGoodsReceivedModal()" class="bg-green-600 text-white px-4 py-2 rounded-md text-center text-sm font-medium hover:bg-green-700 transition-colors duration-200 shadow-sm hover:shadow-md border border-green-700">
                Goods Received
              </button>
            <% end %>
          </div>
          
          <!-- Row 4: Invoice Matched -->
          <div class="flex gap-2 justify-center">
            <% if @purchase_order.status == 'goods_received' %>
              <button onclick="confirmAndUpdateStatus('invoice_matched')" class="bg-green-600 text-white px-4 py-2 rounded-md text-center text-sm font-medium hover:bg-green-700 transition-colors duration-200 shadow-sm hover:shadow-md border border-green-700">
                Invoice Matched
              </button>
            <% end %>
          </div>
          
          <!-- Row 5: Payment Processed -->
          <div class="flex gap-2 justify-center">
            <% if @purchase_order.status == 'invoice_matched' %>
              <button onclick="confirmAndUpdateStatus('payment_processed')" class="bg-green-600 text-white px-4 py-2 rounded-md text-center text-sm font-medium hover:bg-green-700 transition-colors duration-200 shadow-sm hover:shadow-md border border-green-700">
                Payment Processed
              </button>
            <% end %>
          </div>
          
          <!-- Row 6: Cancel -->
          <div class="flex gap-2 justify-center">
            <% unless @purchase_order.cancelled? %>
              <button onclick="confirmAndUpdateStatus('cancelled')" class="bg-red-600 text-white px-4 py-2 rounded-md text-center text-sm font-medium hover:bg-red-700 transition-colors duration-200 shadow-sm hover:shadow-md border border-red-700">
                Cancel
              </button>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Summary Card -->
      <div class="bg-white rounded-lg shadow-sm p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Summary</h3>
        
        <div class="space-y-3">
          <div class="flex justify-between">
            <span class="text-sm text-gray-600">PO Number:</span>
            <span class="text-sm font-medium text-gray-900 font-mono"><%= @purchase_order.po_number %></span>
          </div>
          
          <div class="flex justify-between">
            <span class="text-sm text-gray-600">Total Items:</span>
            <span class="text-sm font-medium text-gray-900"><%= @purchase_request.items.count %></span>
          </div>
          
          <div class="flex justify-between">
            <span class="text-sm text-gray-600">Total Amount:</span>
            <span class="text-sm font-medium text-gray-900">$<%= number_with_precision(@purchase_order.total_amount, precision: 2) %></span>
          </div>
          
          <div class="flex justify-between">
            <span class="text-sm text-gray-600">Related PR:</span>
            <a href="<%= purchase_request_detail_path(@purchase_request) %>" class="text-sm font-medium text-blue-600 hover:text-blue-800">#<%= @purchase_request.id %></a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Goods Received Modal -->
<div id="goodsReceivedModal" class="fixed inset-0 bg-white bg-opacity-10 overflow-y-auto h-full w-full hidden z-50">
  <div class="relative top-20 mx-auto p-6 border w-96 shadow-lg rounded-md bg-white min-h-96">
    <div class="mt-3">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900">Goods Received</h3>
        <button onclick="closeGoodsReceivedModal()" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <form id="goodsReceivedForm">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Note</label>
          <textarea id="deliveryNote" name="delivery_note" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 resize-none" placeholder="Enter delivery note number or details..."></textarea>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Inspection Report</label>
          <input type="file" id="inspectionReport" name="inspection_report" accept=".pdf,.jpg,.jpeg,.png" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
        </div>
        
        <div class="flex justify-end space-x-3">
          <button type="button" onclick="closeGoodsReceivedModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
            Cancel
          </button>
          <button type="button" onclick="submitGoodsReceived()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
            Mark as Received
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function confirmAndUpdateStatus(status) {
    const messages = {
      'approved': 'Are you sure you want to approve this purchase order?',
      'sent': 'Are you sure you want to send this purchase order to the vendor?',
      'invoice_matched': 'Are you sure the invoice has been matched with the PO and delivery receipt?',
      'payment_processed': 'Are you sure payment has been processed for this purchase order?',
      'cancelled': 'Are you sure you want to cancel this purchase order?'
    };

    const message = messages[status];
    
    if (confirm(message)) {
      // Create a form and submit it
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/purchase-order/<%= @purchase_order.id %>/update-status`;
      
      // Add CSRF token
      const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'authenticity_token';
      csrfInput.value = csrfToken;
      form.appendChild(csrfInput);
      
      // Add method override for PATCH
      const methodInput = document.createElement('input');
      methodInput.type = 'hidden';
      methodInput.name = '_method';
      methodInput.value = 'PATCH';
      form.appendChild(methodInput);
      
      // Add status parameter
      const statusInput = document.createElement('input');
      statusInput.type = 'hidden';
      statusInput.name = 'status';
      statusInput.value = status;
      form.appendChild(statusInput);
      
      document.body.appendChild(form);
      form.submit();
    }
  }

  function openGoodsReceivedModal() {
    document.getElementById('goodsReceivedModal').classList.remove('hidden');
  }

  function closeGoodsReceivedModal() {
    document.getElementById('goodsReceivedModal').classList.add('hidden');
  }

        function submitGoodsReceived() {
          if (confirm('Are you sure the goods/services have been received and verified?')) {
            // Create a form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/purchase-order/<%= @purchase_order.id %>/update-status`;
            form.enctype = 'multipart/form-data';
            
            // Add CSRF token
            const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'authenticity_token';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
            
            // Add method override for PATCH
            const methodInput = document.createElement('input');
            methodInput.type = 'hidden';
            methodInput.name = '_method';
            methodInput.value = 'PATCH';
            form.appendChild(methodInput);
            
            // Add status parameter
            const statusInput = document.createElement('input');
            statusInput.type = 'hidden';
            statusInput.name = 'status';
            statusInput.value = 'goods_received';
            form.appendChild(statusInput);
            
            // Add delivery note
            const deliveryNote = document.getElementById('deliveryNote').value;
            if (deliveryNote) {
              const deliveryNoteInput = document.createElement('input');
              deliveryNoteInput.type = 'hidden';
              deliveryNoteInput.name = 'delivery_note';
              deliveryNoteInput.value = deliveryNote;
              form.appendChild(deliveryNoteInput);
            }
            
            // Add inspection report file
            const inspectionReport = document.getElementById('inspectionReport').files[0];
            if (inspectionReport) {
              const fileInput = document.createElement('input');
              fileInput.type = 'file';
              fileInput.name = 'inspection_report';
              fileInput.files = document.getElementById('inspectionReport').files;
              form.appendChild(fileInput);
            }
            
            // Add notes
            const notesInput = document.createElement('input');
            notesInput.type = 'hidden';
            notesInput.name = 'notes';
            notesInput.value = 'Goods received and verified';
            form.appendChild(notesInput);
            
            document.body.appendChild(form);
            form.submit();
          }
        }
</script>
