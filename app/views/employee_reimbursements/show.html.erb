<header class="bg-white shadow-sm border-b border-gray-200">
  <div class="flex items-center justify-between px-6 py-4">
    <div class="flex items-center space-x-4">
      <a href="<%= employee_reimbursements_path %>" class="text-gray-500 hover:text-gray-700">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </a>
      <div class="flex items-center space-x-3">
        <h1 class="text-2xl font-bold text-gray-900">Employee Reimbursement #<%= @employee_reimbursement.id %></h1>
      </div>
    </div>
    
    <div class="flex items-center space-x-4">
      <a href="<%= edit_employee_reimbursement_path(@employee_reimbursement) %>" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors duration-200 flex items-center space-x-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
        </svg>
        <span>Edit</span>
      </a>
    </div>
  </div>
</header>

<main class="flex-1 overflow-y-auto">
  <div class="p-6">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Main Content -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Cash Advance Request Information -->
        <div class="bg-white rounded-lg shadow">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Cash Advance Request</h2>
          </div>
          <div class="p-6 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700">Cash Advance Request ID</label>
                <p class="mt-1 text-sm text-gray-900">
                  <%= link_to "CAR ##{@employee_reimbursement.cash_advance_request.id}", cash_advance_request_path(@employee_reimbursement.cash_advance_request), class: "text-red-600 hover:text-red-900" %>
                </p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Employee Name</label>
                <p class="mt-1 text-sm text-gray-900"><%= @employee_reimbursement.cash_advance_request.employee_name %></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Employee ID</label>
                <p class="mt-1 text-sm text-gray-900"><%= @employee_reimbursement.cash_advance_request.employee_id %></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Department</label>
                <p class="mt-1 text-sm text-gray-900"><%= @employee_reimbursement.cash_advance_request.department %></p>
              </div>
              <% if @employee_reimbursement.cash_advance_request.sales_order_number.present? %>
                <div>
                  <label class="block text-sm font-medium text-gray-700">Sales Order Number</label>
                  <p class="mt-1 text-sm text-gray-900"><%= @employee_reimbursement.cash_advance_request.sales_order_number %></p>
                </div>
              <% end %>
              <% if @employee_reimbursement.cash_advance_request.client_name.present? %>
                <div>
                  <label class="block text-sm font-medium text-gray-700">Client Name</label>
                  <p class="mt-1 text-sm text-gray-900"><%= @employee_reimbursement.cash_advance_request.client_name %></p>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Reimbursement Details -->
        <div class="bg-white rounded-lg shadow">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Reimbursement Details</h2>
          </div>
          <div class="p-6 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700">Amount to Reimburse</label>
                <p class="mt-1 text-sm text-gray-900">₱<%= number_with_precision(@employee_reimbursement.amount_to_reimburse, precision: 2) %></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Created</label>
                <p class="mt-1 text-sm text-gray-900"><%= @employee_reimbursement.created_at.strftime("%B %d, %Y") %></p>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Description</label>
              <p class="mt-1 text-sm text-gray-900 whitespace-pre-line"><%= @employee_reimbursement.description %></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- Status -->
        <div class="bg-white rounded-lg shadow">
          <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Status</h3>
          </div>
          <div class="p-6 space-y-4">
            <div class="flex flex-col">
              <div class="flex items-center justify-between mb-2">
                <label class="text-sm font-medium text-gray-700">Finance Status</label>
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                  <%= case @employee_reimbursement.finance_status
                      when 'finance_pending' then 'bg-yellow-100 text-yellow-800'
                      when 'finance_approved' then 'bg-green-100 text-green-800'
                      when 'finance_rejected' then 'bg-red-100 text-red-800'
                      else 'bg-gray-100 text-gray-800'
                      end %>">
                  <%= @employee_reimbursement.finance_status&.humanize || 'Unknown' %>
                </span>
              </div>
              <% if @employee_reimbursement.finance_status == 'finance_rejected' && @employee_reimbursement.finance_comments.present? %>
                <div class="mt-2 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-800">
                  <strong>Note:</strong> <%= truncate(@employee_reimbursement.finance_comments, length: 100) %>
                </div>
              <% end %>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium text-gray-700">Created</span>
              <span class="text-sm text-gray-900"><%= @employee_reimbursement.created_at.strftime("%m/%d/%Y") %></span>
            </div>
          </div>
        </div>

        <!-- Finance Notes -->
        <% if @employee_reimbursement.finance_comments.present? %>
        <div class="bg-white rounded-lg shadow">
          <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Finance Notes</h3>
          </div>
          <div class="p-6">
            <p class="text-sm text-gray-900 whitespace-pre-line"><%= @employee_reimbursement.finance_comments %></p>
          </div>
        </div>
        <% end %>

        <!-- Actions -->
        <% if current_user&.admin? || current_user&.department_finance? %>
        <% if @employee_reimbursement.finance_status != 'finance_approved' %>
        <div class="bg-white rounded-lg shadow">
          <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Actions</h3>
          </div>
          <div class="p-6 space-y-3">
            <button onclick="confirmFinanceAction('approve')" class="w-full bg-green-600 text-white px-4 py-2 rounded-md text-center text-sm font-medium hover:bg-green-700 transition-colors duration-200 shadow-sm hover:shadow-md border border-green-700">
              Approve
            </button>
            <button onclick="openFinanceRejectModal()" class="w-full bg-red-600 text-white px-4 py-2 rounded-md text-center text-sm font-medium hover:bg-red-700 transition-colors duration-200 shadow-sm hover:shadow-md border border-red-700">
              Reject
            </button>
          </div>
        </div>
        <% end %>
        <% end %>

        <!-- Summary -->
        <div class="bg-white rounded-lg shadow">
          <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Summary</h3>
          </div>
          <div class="p-6 space-y-3">
            <div class="flex justify-between">
              <span class="text-sm text-gray-600">Amount to Reimburse:</span>
              <span class="text-sm font-medium text-gray-900">₱<%= number_with_precision(@employee_reimbursement.amount_to_reimburse, precision: 2) %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-gray-600">Created:</span>
              <span class="text-sm font-medium text-gray-900"><%= @employee_reimbursement.created_at.strftime("%B %d, %Y") %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-gray-600">Requester:</span>
              <span class="text-sm font-medium text-gray-900"><%= @employee_reimbursement.requester_user&.full_name || 'Unknown' %></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Finance Reject Modal -->
<div id="financeRejectModal" class="fixed inset-0 bg-white bg-opacity-10 overflow-y-auto h-full w-full hidden z-50">
  <div class="relative top-20 mx-auto p-6 border w-96 shadow-lg rounded-md bg-white min-h-96">
    <div class="mt-3">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900">Reject Request</h3>
        <button onclick="closeFinanceRejectModal()" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <form id="financeRejectForm">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Rejection Reason *</label>
          <textarea id="financeRejectNotes" name="finance_comments" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 resize-none" placeholder="Please provide a reason for rejection..." required></textarea>
        </div>
        
        <div class="flex justify-end space-x-3">
          <button type="button" onclick="closeFinanceRejectModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
            Cancel
          </button>
          <button type="button" onclick="submitFinanceReject()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
            Reject Request
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Finance Approve Modal -->
<div id="financeApproveModal" class="fixed inset-0 bg-white bg-opacity-10 overflow-y-auto h-full w-full hidden z-50">
  <div class="relative top-20 mx-auto p-6 border w-96 shadow-lg rounded-md bg-white min-h-96">
    <div class="mt-3">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900">Approve Request</h3>
        <button onclick="closeFinanceApproveModal()" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <form id="financeApproveForm">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
          <textarea id="financeApproveNotes" name="finance_comments" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 resize-none" placeholder="Please provide notes..."></textarea>
        </div>
        
        <div class="flex justify-end space-x-3">
          <button type="button" onclick="closeFinanceApproveModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
            Cancel
          </button>
          <button type="button" onclick="submitFinanceApprove()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
            Approve Request
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function confirmFinanceAction(action) {
  if (action === 'approve') {
    openFinanceApproveModal();
  } else {
    openFinanceRejectModal();
  }
}

function openFinanceApproveModal() {
  document.getElementById('financeApproveModal').classList.remove('hidden');
}

function closeFinanceApproveModal() {
  document.getElementById('financeApproveModal').classList.add('hidden');
}

function submitFinanceApprove() {
  if (confirm('Are you sure you want to approve this reimbursement request?')) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/employee-reimbursements/<%= @employee_reimbursement.id %>/approve-finance`;
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'authenticity_token';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    const methodInput = document.createElement('input');
    methodInput.type = 'hidden';
    methodInput.name = '_method';
    methodInput.value = 'PATCH';
    form.appendChild(methodInput);
    
    const notesInput = document.createElement('input');
    notesInput.type = 'hidden';
    notesInput.name = 'finance_comments';
    notesInput.value = document.getElementById('financeApproveNotes').value;
    form.appendChild(notesInput);
    
    document.body.appendChild(form);
    form.submit();
  }
}

function openFinanceRejectModal() {
  document.getElementById('financeRejectModal').classList.remove('hidden');
}

function closeFinanceRejectModal() {
  document.getElementById('financeRejectModal').classList.add('hidden');
}

function submitFinanceReject() {
  const notesValue = document.getElementById('financeRejectNotes').value.trim();
  if (!notesValue) {
    alert('Please provide a rejection reason.');
    return;
  }
  
  if (confirm('Are you sure you want to reject this reimbursement request?')) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/employee-reimbursements/<%= @employee_reimbursement.id %>/reject-finance`;
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'authenticity_token';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    const methodInput = document.createElement('input');
    methodInput.type = 'hidden';
    methodInput.name = '_method';
    methodInput.value = 'PATCH';
    form.appendChild(methodInput);
    
    const notesInput = document.createElement('input');
    notesInput.type = 'hidden';
    notesInput.name = 'finance_comments';
    notesInput.value = notesValue;
    form.appendChild(notesInput);
    
    document.body.appendChild(form);
    form.submit();
  }
}
</script>
