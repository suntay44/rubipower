<header class="bg-white shadow-sm border-b border-gray-200">
  <div class="flex items-center justify-between px-6 py-4">
    <div class="flex items-center space-x-4">
      <a href="<%= employee_reimbursement_path(@employee_reimbursement) %>" class="text-gray-500 hover:text-gray-700">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </a>
      <div class="flex items-center space-x-3">
        <h1 class="text-2xl font-bold text-gray-900">Edit Employee Reimbursement</h1>
      </div>
    </div>
  </div>
</header>

<main class="flex-1 overflow-y-auto">
  <div class="p-6">
    <%= form_with model: @employee_reimbursement, local: true, class: "space-y-8" do |form| %>
      <% if @employee_reimbursement.errors.any? %>
        <div class="bg-red-50 border border-red-200 rounded-md p-4 mb-6">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-red-800">
                There were <%= pluralize(@employee_reimbursement.errors.count, "error") %> with your submission:
              </h3>
              <div class="mt-2 text-sm text-red-700">
                <ul class="list-disc list-inside space-y-1">
                  <% @employee_reimbursement.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Cash Advance Request Selection -->
      <div class="bg-white rounded-lg shadow-sm p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Cash Advance Request</h3>
        <div>
          <%= form.label :cash_advance_request_id, "Select Cash Advance Request *", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <div class="relative">
            <input type="text" id="car_search" placeholder="Search by ID, employee name, or order number..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500" onkeyup="filterCashAdvanceRequests()" onfocus="showCarDropdown()" autocomplete="off" required value="<%= @employee_reimbursement.cash_advance_request ? "##{@employee_reimbursement.cash_advance_request.id} - #{@employee_reimbursement.cash_advance_request.employee_name} (#{@employee_reimbursement.cash_advance_request.sales_order_number || 'N/A'})" : '' %>">
            <%= form.hidden_field :cash_advance_request_id, id: "car_id_hidden", required: true, value: @employee_reimbursement.cash_advance_request_id %>
            <div id="car_dropdown" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
              <!-- Dropdown items will be populated here -->
            </div>
          </div>
          <div id="selected_car_display" class="mt-2 p-2 bg-gray-50 border border-gray-200 rounded-md text-sm text-gray-700 <%= 'hidden' unless @employee_reimbursement.cash_advance_request.present? %>">
            <span class="font-medium">Selected: </span><span id="selected_car_text"><%= @employee_reimbursement.cash_advance_request ? "##{@employee_reimbursement.cash_advance_request.id} - #{@employee_reimbursement.cash_advance_request.employee_name} (#{@employee_reimbursement.cash_advance_request.sales_order_number || 'N/A'})" : '' %></span>
          </div>
          <p class="text-xs text-gray-500 mt-1">Select an approved cash advance request</p>
        </div>
      </div>

      <!-- Reimbursement Details -->
      <div class="bg-white rounded-lg shadow-sm p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Reimbursement Details</h3>
        <div class="space-y-6">
          <div>
            <%= form.label :amount_to_reimburse, "Amount to Reimburse (₱) *", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= form.number_field :amount_to_reimburse, step: 0.01, required: true, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500" %>
          </div>
          
          <div>
            <%= form.label :description, "Description *", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= form.text_area :description, required: true, rows: 4, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500", placeholder: "Describe what expenses are being reimbursed..." %>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="flex justify-end space-x-4">
        <%= link_to "Cancel", employee_reimbursement_path(@employee_reimbursement), class: "px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors duration-200" %>
        <%= form.submit "Update Reimbursement", class: "px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors duration-200" %>
      </div>
    <% end %>
  </div>
</main>

<script>
  // Cash Advance Request data for JavaScript
  const cashAdvanceRequests = <%= raw @cash_advance_requests.map { |car| { id: car.id, employee_name: car.employee_name, employee_id: car.employee_id, sales_order_number: car.sales_order_number || '', amount_requested: car.amount_requested.to_f, created_at: car.created_at.strftime("%b %d, %Y") } }.to_json %>;

  // Function to show dropdown
  function showCarDropdown() {
    const dropdown = document.getElementById('car_dropdown');
    const searchInput = document.getElementById('car_search');
    
    if (dropdown && searchInput) {
      dropdown.classList.remove('hidden');
      filterCashAdvanceRequests();
    }
  }

  // Function to hide dropdown
  function hideCarDropdown() {
    const dropdown = document.getElementById('car_dropdown');
    if (dropdown) {
      setTimeout(() => {
        dropdown.classList.add('hidden');
      }, 200);
    }
  }

  // Function to select a cash advance request
  function selectCashAdvanceRequest(carId, displayText) {
    const searchInput = document.getElementById('car_search');
    const hiddenInput = document.getElementById('car_id_hidden');
    const selectedDisplay = document.getElementById('selected_car_display');
    const selectedText = document.getElementById('selected_car_text');
    const dropdown = document.getElementById('car_dropdown');
    
    if (searchInput && hiddenInput) {
      hiddenInput.value = carId;
      searchInput.value = displayText;
      if (selectedDisplay && selectedText) {
        selectedText.textContent = displayText;
        selectedDisplay.classList.remove('hidden');
      }
      if (dropdown) {
        dropdown.classList.add('hidden');
      }
    }
  }

  // Function to filter cash advance requests
  function filterCashAdvanceRequests() {
    const searchInput = document.getElementById('car_search');
    const dropdown = document.getElementById('car_dropdown');
    const filter = searchInput.value.toLowerCase().trim();
    
    if (!dropdown) return;
    
    // Clear dropdown
    dropdown.innerHTML = '';
    
    // Filter by ID, employee name, or sales order number
    const filteredCars = cashAdvanceRequests.filter(car => {
      const idMatch = car.id.toString().includes(filter);
      const employeeMatch = car.employee_name && car.employee_name.toLowerCase().includes(filter);
      const orderMatch = car.sales_order_number && car.sales_order_number.toLowerCase().includes(filter);
      return idMatch || employeeMatch || orderMatch;
    });
    
    if (filteredCars.length === 0 && filter !== '') {
      dropdown.innerHTML = '<div class="px-3 py-2 text-sm text-gray-500">No cash advance requests found</div>';
      return;
    }
    
    // Show all if search is empty, otherwise show filtered
    const carsToShow = filter === '' ? cashAdvanceRequests : filteredCars;
    
    carsToShow.forEach(car => {
      const item = document.createElement('div');
      item.className = 'px-3 py-2 hover:bg-red-50 cursor-pointer border-b border-gray-100';
      item.innerHTML = `
        <div class="font-medium text-gray-900">#${car.id} - ${car.employee_name}</div>
        <div class="text-xs text-gray-500">Order: ${car.sales_order_number || 'N/A'} | Amount: ₱${car.amount_requested.toFixed(2)} | ${car.created_at}</div>
      `;
      item.onclick = () => {
        const displayText = `#${car.id} - ${car.employee_name} (${car.sales_order_number || 'N/A'})`;
        selectCashAdvanceRequest(car.id, displayText);
      };
      dropdown.appendChild(item);
    });
    
    // Show dropdown if there are results
    if (carsToShow.length > 0) {
      dropdown.classList.remove('hidden');
    }
  }

  // Hide dropdown when clicking outside
  document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', function(e) {
      const searchInput = document.getElementById('car_search');
      const dropdown = document.getElementById('car_dropdown');
      if (searchInput && dropdown && !searchInput.contains(e.target) && !dropdown.contains(e.target)) {
        hideCarDropdown();
      }
    });
  });
</script>
